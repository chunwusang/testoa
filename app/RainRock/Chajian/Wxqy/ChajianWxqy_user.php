<?php
 namespace App\RainRock\Chajian\Wxqy; use App\Model\Base\WxqyuserModel; use App\Model\Base\WxqydeptModel; use App\Model\Base\UseraModel; use DB; class ChajianWxqy_user extends ChajianWxqy { public function getuserlist() { $pid = $this->deptrootid; $token = $this->gettoken(); if(is_array($token))return $token; $url = ''.$this->gettourl('URL_userlist').'?access_token='.$token.'&department_id='.$pid.'&fetch_child=1'; $arr = $this->runcurl($url); $barr = $this->setbackarr($arr->errcode, $arr->errmsg); if($arr->errcode==0){ $list = $arr->userlist; $idss = [0]; foreach($list as $k=>$rs){ $id = $this->saveuserinfo($rs); $idss[] = $id; } WxqyuserModel::where('cid', $this->companyid)->whereNotin('id', $idss)->delete(); } return $barr; } private function saveuserinfo($rs) { $userid = $rs->userid; $uors = WxqyuserModel::where(['cid'=>$this->companyid,'userid'=>$userid])->first(); if(!$uors)$uors = new WxqyuserModel(); $sarr = array( 'userid' => $userid, 'name' => $rs->name, 'cid' => $this->companyid, 'department'=> json_encode($rs->department), 'position' => objvalue($rs, 'position'), 'telephone' => objvalue($rs, 'telephone'), 'mobile' => objvalue($rs, 'mobile'), 'gender' => $rs->gender, 'status' => $rs->status, 'enable' => $rs->enable, 'email' => objvalue($rs, 'email'), 'avatar' => objvalue($rs, 'avatar'), 'english_name' => objvalue($rs, 'english_name'), ); foreach($sarr as $k=>$v)$uors->$k = $v; $uors->save(); return $uors->id; } public function getuserarr($userids=null) { $obj = WxqyuserModel::where('cid', $this->companyid); if($userids && is_array($userids))$obj = $obj->whereIn('userid', $userids); $rows = $obj->get(); $barr = array(); foreach($rows as $k=>$rs)$barr[$rs->userid] = $rs; return $barr; } public function updateuser($id) { $rs = UseraModel::where(['cid'=>$this->companyid,'id'=>$id])->first(); if(!$rs)return $this->backerror('用户不存在了'); $user= $rs->user; if(isempt($user))return $this->backerror('没有设置用户名不能更新创建'); $wxrs = WxqyuserModel::where(['cid'=>$this->companyid,'userid'=>$user])->first(); return $this->updateuserss($user, $rs, $wxrs); } private function updateuserss($userid, $rs, $wxrs) { $bupi = c('dept')->getrootid($this->companyid); $department[] = $rs->deptid; $order[] = $rs->sort; if(!isempt($rs->deptids)){ $adeptids = explode(',', $rs->deptids); foreach($adeptids as $dis){ $department[] = $dis; $order[] = $rs->sort; } } foreach($department as $k=>$dis){ if($dis==$bupi)$department[$k] = $this->deptrootid; } $usrr['userid'] = $userid; $usrr['name'] = $rs->name; $usrr['position'] = $rs->position; $usrr['mobile'] = $rs->mobile; $usrr['gender'] = $rs->gender; $usrr['email'] = $rs->email; $usrr['telephone'] = $rs->tel; $usrr['enable'] = $rs->status==2 ? 0 : 1; $usrr['department'] = $department; $usrr['order'] = $order; $body = json_encode($usrr, JSON_UNESCAPED_UNICODE); $token = $this->gettoken(); if(!$wxrs){ $url = ''.$this->gettourl('URL_usercreate').'?access_token='.$token.''; }else{ $url = ''.$this->gettourl('URL_userupdate').'?access_token='.$token.''; } $arr = $this->runcurl($url, $body); $barr = $this->setbackarr($arr->errcode, $arr->errmsg); if($arr->errcode==0){ unset($usrr['order']); if(!$wxrs)$wxrs = new WxqyuserModel(); $wxrs->cid = $this->companyid; $usrr['department'] = json_encode($usrr['department']); if($rs->status==2)$usrr['status'] = 2; foreach($usrr as $k=>$v)$wxrs->$k = $v; $wxrs->save(); } return $barr; } public function getuserinfo($userid) { $token = $this->gettoken(); $url = ''.$this->gettourl('URL_userget').'?access_token='.$token.'&userid='.$userid.''; $arr = $this->runcurl($url); $barr = $this->setbackarr($arr->errcode, $arr->errmsg); if($arr->errcode==0){ $this->saveuserinfo($arr); } return $barr; } public function isgeng($urs, $rs) { if(!$urs || !$rs)return 1; $isgc = 0; $deptid = $rs['deptid']; $deptids = objvalue($rs,'deptids'); if(!isempt($deptids))$deptid.=','.$deptids.''; $zt =($rs->status==2)?0:1; $gxls = explode(',',',职位,姓名,部门,邮箱,性别,状态,电话'); if($urs->position!=$rs->position)$isgc=1; if($urs->name!=$rs->name)$isgc=2; if($urs->department!='['.$deptid.']')$isgc=3; if($urs->email!=$rs->email)$isgc=4; if($urs->gender!=$rs->gender)$isgc=5; if($urs->enable!=$zt)$isgc=6; if($urs->telephone!=$rs->tel)$isgc=7; return array($isgc, $gxls[$isgc]); } public function deleteuser($sid) { $siad = explode(',', $sid); $rows = UseraModel::where('cid', $this->companyid)->whereIn('id', $siad)->get(); $useridlist = array(); foreach($rows as $k=>$rs){ if(!isempt($rs->user))$useridlist[] = $rs->user; } if(!$useridlist)return $this->backerror('没有可删除的用户1'); $ulist = $this->getuserarr($useridlist); if(!$ulist)return $this->backerror('没有可删除的用户，可能用户未创建'); $useridlist = array(); foreach($ulist as $keli=>$kesr)$useridlist[] = $keli; $token = $this->gettoken(); $url = ''.$this->gettourl('URL_batchdelete').'?access_token='.$token.''; $body = json_encode(['useridlist'=>$useridlist], JSON_UNESCAPED_UNICODE);; $arr = $this->runcurl($url, $body); $barr = $this->setbackarr($arr->errcode, $arr->errmsg); if($arr->errcode==0){ WxqyuserModel::where('cid', $this->companyid)->whereIn('userid', $useridlist)->delete(); } return $barr; } public function delaluser() { $useridlist = $this->getnoinsys('', 1); if(!$useridlist)return $this->backerror('没有可删除的用户'); $token = $this->gettoken(); $url = ''.$this->gettourl('URL_batchdelete').'?access_token='.$token.''; $body = json_encode(['useridlist'=>$useridlist], JSON_UNESCAPED_UNICODE);; $arr = $this->runcurl($url, $body); $barr = $this->setbackarr($arr->errcode, $arr->errmsg); if($arr->errcode==0){ WxqyuserModel::where('cid', $this->companyid)->whereIn('userid', $useridlist)->delete(); } return $barr; } public function getnoinsys($ids='',$glx=0) { $qz = DB::getTablePrefix(); $sql = "select a.`userid`,a.`name` from `".$qz."wxqyuser` a left join `".$qz."usera` b on a.`userid`=b.`user`and a.cid=b.cid where a.cid=".$this->companyid.""; if($ids!=''){ $sql.= " and b.id in($ids)"; }else{ $sql.= ' and b.id is null'; } $rows= DB::select($sql); $arr = array(); foreach($rows as $k=>$rs){ if($glx==0){ $arr[] = ''.$rs->name.'('.$rs->userid.')'; }else{ $arr[] = $rs->userid; } } return $arr; } public function anaytouser() { $rows = WxqyuserModel::where('cid', $this->companyid)->get(); if(!$rows)return $this->backerror('请先获取列表在同步'); if(WxqydeptModel::where('cid', $this->companyid)->count()==0) return $this->backerror('请先获取企业微信组织结构列表后在同步'); $bupi = c('dept')->getrootid($this->companyid); $pyobj = c('pingyin'); $idss = []; foreach($rows as $k=>$rs){ $data = UseraModel::where(['cid'=>$this->companyid,'user'=>$rs->userid])->first(); if(!$data){ $data = new UseraModel(); $data->cid = $this->companyid; $data->uid = 0; $data->status = 0; } if(!isempt($data->pingyin))$data->pingyin = $pyobj->get($rs->name); $data->position = $rs->position; $data->mobile = $rs->mobile; if(!isempt($rs->email))$data->email = $rs->email; $data->gender = $rs->gender; if(!isempt($rs->telephone))$data->tel = $rs->telephone; if($rs->enable==0)$data->status = 2; $data->name = $rs->name; $data->user = $rs->userid; if(!isempt($rs->department)){ $depta = json_decode($rs->department, true); $deptid = $depta[0]; $deptids = ''; for($i=0;$i<count($depta);$i++){ $sid = $depta[$i]; if($sid==$this->deptrootid)$sid = $bupi; if($i==0){ $deptid = $sid; }else{ $deptids.=','.$sid.''; } } if(!isempt($deptids))$deptids = substr($deptids, 1); $data->deptids = $deptids; $data->deptid = $deptid; } $data->save(); } c('usera')->reloaddata($this->companyid); return $this->setbackarr(0,'同步成功'); } }