<?php
 namespace App\RainRock\Chajian\Wxqy; use App\Model\Base\WxqyagentModel; use App\Model\Base\AgenhModel; class ChajianWxqy_agent extends ChajianWxqy { public function getagent($id) { $token = $this->gettoken($id, true); if(is_array($token))return $token; $url = ''.$this->gettourl('URL_agentget').'?access_token='.$token.'&agentid='.$id.''; $arr = $this->runcurl($url); $barr = $this->setbackarr($arr->errcode, $arr->errmsg); if($arr->errcode==0){ $obj = WxqyagentModel::where(['cid'=>$this->companyid,'agentid'=>$id])->first(); $uarr = array( 'name' => $arr->name, 'square_logo_url' => $arr->square_logo_url, 'description' => $arr->description, 'allow_userinfos' => json_encode($arr->allow_userinfos), 'allow_partys' => json_encode($arr->allow_partys), 'close' => $arr->close, 'redirect_domain' => $arr->redirect_domain, 'home_url' => $arr->home_url, 'report_location_flag' => $arr->report_location_flag, 'isreportenter' => $arr->isreportenter, ); if(isempt($uarr['description']))unset($uarr['description']); if(isempt($uarr['redirect_domain']))unset($uarr['redirect_domain']); if(isempt($uarr['home_url']) || $obj->agenhid>0)unset($uarr['home_url']); foreach($uarr as $k=>$v)$obj->$k = $v; $obj->save(); } return $this->backarr; } public function setagent($id) { $rs = WxqyagentModel::where(['cid'=>$this->companyid,'agentid'=>$id])->first(); if(!$rs)return $this->backerror('微信应用不存在'); if(isempt($rs->square_logo_url))return $this->backerror('请先获取信息在更新'); $uarr['name'] = $rs->name; $uarr['agentid'] = (int)$rs->agentid; if(!isempt($rs->home_url))$uarr['home_url'] = $rs->home_url; if(!isempt($rs->redirect_domain))$uarr['redirect_domain'] = $rs->redirect_domain; if(!isempt($rs->description))$uarr['description'] = $rs->description; $uarr['report_location_flag'] = $rs->report_location_flag; $uarr['isreportenter'] = $rs->isreportenter; $body = str_replace('{agentid}', $id, json_encode($uarr, JSON_UNESCAPED_UNICODE)); $token = $this->gettoken($id, true); if(is_array($token))return $token; $url = ''.$this->gettourl('URL_agentset').'?access_token='.$token.''; $arr = $this->runcurl($url, $body); $barr = $this->setbackarr($arr->errcode, $arr->errmsg); if($arr->errcode==0){ } return $barr; } public function menuupdate($id) { $rs = WxqyagentModel::where(['cid'=>$this->companyid,'agentid'=>$id])->first(); if(!$rs)return $this->backerror('微信应用不存在'); $token = $this->gettoken($id, true); if(is_array($token))return $token; $body = str_replace('{agentid}', $id, $rs['menujson']); $menu = json_decode($body, true); if(!$menu || isempt($body)){ return $this->backerror('没有设置菜单,可以选择操作删除菜单'); } $body = str_replace('{agentid}', $id, $body); $url = ''.$this->gettourl('URL_menucreate').'?access_token='.$token.'&agentid='.$id.''; $arr = $this->runcurl($url, $body); $barr = $this->setbackarr($arr->errcode, $arr->errmsg); if($arr->errcode==0){ } return $barr; } public function menudelete($id) { $rs = WxqyagentModel::where(['cid'=>$this->companyid,'agentid'=>$id])->first(); if(!$rs)return $this->backerror('微信应用不存在'); $token = $this->gettoken($id, true); if(is_array($token))return $token; $url = ''.$this->gettourl('URL_menudelete').'?access_token='.$token.'&agentid='.$id.''; $arr = $this->runcurl($url); $barr = $this->setbackarr($arr->errcode, $arr->errmsg); if($arr->errcode==0){ } return $barr; } public function getmenu($id) { $rs = WxqyagentModel::where(['cid'=>$this->companyid,'agentid'=>$id])->first(); if(!$rs)return $this->backerror('微信应用不存在'); $token = $this->gettoken($id, true); if(is_array($token))return $token; $url = ''.$this->gettourl('URL_menuget').'?access_token='.$token.'&agentid='.$id.''; $arr = $this->runcurl($url); $barr = $this->setbackarr($arr->errcode, $arr->errmsg); if($arr->errcode==0){ $button = $arr->button; $ssss['button'] = $button; $rs->menujson = json_encode($ssss, JSON_UNESCAPED_UNICODE); $rs->save(); } return $barr; } public function menuse($id) { $agentrs = WxqyagentModel::where(['cid'=>$this->companyid,'agentid'=>$id])->first(); if(!$agentrs)return $this->backerror('微信应用不存在'); $agenhid = $agentrs->agenhid; if($agenhid==0)return $this->backerror('此应用没有管理系统应用'); $this->agentid = $id; $agenhinfo = AgenhModel::where(['cid'=>$this->companyid,'id'=>$agenhid])->first(); if(!$agenhinfo)return $this->backerror('关联系统应用不存在了'); $menuarr = $this->getNei('agenh')->getMenuArr($agenhinfo, true); if(!$menuarr) return $this->backerror('系统应用['.$agenhinfo->name.']没有菜单'); $button = array(); foreach($menuarr as $k=>$rs){ if($rs->pid>0)continue; $sarr = array('name' => $rs->name); if($rs->stotal==0){ $sarr['type']= 'view'; $sarr['url'] = $this->gerusers($rs, $agenhinfo); }else{ $sarr['sub_button'] = $this->getusrra($menuarr, $rs->id, $agenhinfo); } $button[] = $sarr; } $barrs['button'] = $button; $menujson = json_encode($barrs, JSON_UNESCAPED_UNICODE); WxqyagentModel::where(['cid'=>$this->companyid,'id'=>$agentrs->id])->update([ 'menujson'=>$menujson ]); return $this->menuupdate($id); } private function getusrra($menuarr, $pid=0, $agenhinfo) { $button = array(); foreach($menuarr as $k=>$rs){ if($rs->pid!=$pid)continue; $sarr = array('name' => $rs->name); $sarr['type']= 'view'; $sarr['url'] = $this->gerusers($rs, $agenhinfo); $button[] = $sarr; } return $button; } private function gerusers($rs, $agenhinfo) { $url = config('app.urly').'/ying/'.$this->companyinfo->num.'/'.$agenhinfo->num.'?atype='.$rs->url.''; if($rs->type=='add'){ $num = $agenhinfo->num; if(!isempt($rs->url))$num = $rs->url; $url = config('app.urly').'/input/'.$this->companyinfo->num.'/'.$num.''; }elseif($rs->type=='url'){ $url = $rs->url; } $jgs = contain($url,'?') ? '&' : '?'; $url .= ''.$jgs.'agentid='.$this->agentid.''; return $url; } }